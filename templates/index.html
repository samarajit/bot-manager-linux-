<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPi Bot Manager</title>
    <style>
        :root {
            --primary: #208090;
            --primary-dark: #1a6470;
            --bg: #f8f9fa;
            --surface: #fff;
            --text: #1f2125;
            --text-secondary: #626c77;
            --border: #e7eaed;
            --success: #218141;
            --error: #c01530;
            --warning: #a84f2f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }

        .header p {
            margin: 5px 0 0 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        .card h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: rgba(32, 128, 144, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .add-bot {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-bot input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--surface);
            color: var(--text);
        }

        .add-bot input::placeholder {
            color: var(--text-secondary);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: rgba(32, 128, 144, 0.12);
            color: var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(32, 128, 144, 0.18);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .bot-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bot-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bot-info {
            flex: 1;
        }

        .bot-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .bot-path {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .bot-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin-top: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.running {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .bot-actions {
            display: flex;
            gap: 6px;
        }

        .logs-container {
            background: #1e1e1e;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-time {
            color: #888;
            margin-right: 8px;
        }

        .log-error {
            color: #ff6b6b;
        }

        .log-success {
            color: #51cf66;
        }

        .log-info {
            color: #74c0fc;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 16px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 200ms;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.running {
            background: rgba(33, 129, 65, 0.15);
            color: var(--success);
        }

        .status-badge.stopped {
            background: rgba(198, 9, 47, 0.15);
            color: #c60930;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 300ms ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--bg);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> RPi Bot Manager</h1>
            <p>Manage your Python bots running on Raspberry Pi</p>
        </div>

        <div class="grid">
            <!-- Bot Management -->
            <div class="card">
                <h2><span class="card-icon">‚öôÔ∏è</span> Bot Management</h2>
                
                <div class="add-bot">
                    <input type="text" id="botPath" placeholder="Bot path (e.g., /home/pi/bots/mybot/main.py)">
                    <button class="btn btn-primary btn-small" onclick="addBot()">+ Add Bot</button>
                </div>

                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalBots">0</div>
                        <div class="stat-label">Total Bots</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="runningCount">0</div>
                        <div class="stat-label">Running</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stoppedCount">0</div>
                        <div class="stat-label">Stopped</div>
                    </div>
                </div>

                <div id="botList" class="bot-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div>No bots added yet</div>
                    </div>
                </div>
            </div>

            <!-- Activity Logs -->
            <div class="card">
                <h2><span class="card-icon">üìã</span> Activity Logs</h2>
                
                <div class="tabs" style="margin: -20px -20px 15px -20px; padding-left: 20px; padding-right: 20px; padding-top: 0;">
                    <button class="tab active" onclick="showLogTab('all')">All</button>
                    <button class="tab" onclick="showLogTab('selected')">Selected Bot</button>
                </div>

                <div id="allLogs" class="tab-content active logs-container"></div>
                <div id="selectedLogs" class="tab-content logs-container"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;"></div>

    <script>
        const API_BASE = `http://${window.location.hostname}:5000/api`;
        let selectedBot = null;
        let allBots = [];
        let autoRefresh = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadBots();
            autoRefresh = setInterval(loadBots, 2000);
        });

        async function loadBots() {
            try {
                const response = await fetch(`${API_BASE}/bots`);
                allBots = await response.json();
                renderBots();
                updateStats();
            } catch (error) {
                console.error('Error loading bots:', error);
            }
        }

        function renderBots() {
            const botList = document.getElementById('botList');
            
            if (allBots.length === 0) {
                botList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No bots added yet</div></div>';
                return;
            }

            botList.innerHTML = allBots.map((bot, idx) => `
                <div class="bot-item" onclick="selectBot(${idx})">
                    <div class="bot-info">
                        <div class="bot-name">${bot.name}</div>
                        <div class="bot-path">${bot.path}</div>
                        <div class="bot-status">
                            <span class="status-dot ${bot.running ? 'running' : ''}"></span>
                            <span class="status-badge ${bot.running ? 'running' : 'stopped'}">
                                ${bot.running ? '‚úì Running' : '‚óè Stopped'}
                            </span>
                            ${bot.pid ? `<span style="color: var(--text-secondary); font-size: 11px;">PID: ${bot.pid}</span>` : ''}
                        </div>
                    </div>
                    <div class="bot-actions">
                        <button class="btn btn-sm ${bot.running ? 'btn-secondary' : 'btn-primary'}" 
                                onclick="event.stopPropagation(); toggleBot(${idx})">
                            ${bot.running ? '‚èπ Stop' : '‚ñ∂ Start'}
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); deleteBot(${idx})">
                            üóë Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const running = allBots.filter(b => b.running).length;
            document.getElementById('totalBots').textContent = allBots.length;
            document.getElementById('runningCount').textContent = running;
            document.getElementById('stoppedCount').textContent = allBots.length - running;
        }

        async function addBot() {
            const input = document.getElementById('botPath');
            const path = input.value.trim();

            if (!path) {
                showToast('Please enter a bot path', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/bots/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                const result = await response.json();
                if (response.ok) {
                    input.value = '';
                    showToast('Bot added successfully', 'success');
                    loadBots();
                } else {
                    showToast(result.error || 'Error adding bot', 'error');
                }
            } catch (error) {
                showToast('Error adding bot: ' + error.message, 'error');
            }
        }

        async function toggleBot(idx) {
            try {
                const action = allBots[idx].running ? 'stop' : 'start';
                const response = await fetch(`${API_BASE}/bots/${idx}/${action}`, { method: 'POST' });
                const result = await response.json();

                if (response.ok) {
                    showToast(`Bot ${action}${action === 'start' ? 'ed' : 'ped'} successfully`, 'success');
                    loadBots();
                } else {
                    showToast(result.error || `Error ${action}ing bot`, 'error');
                }
            } catch (error) {
                showToast(`Error ${allBots[idx].running ? 'stopping' : 'starting'} bot: ` + error.message, 'error');
            }
        }

        async function deleteBot(idx) {
            if (confirm('Delete this bot?')) {
                try {
                    const response = await fetch(`${API_BASE}/bots/${idx}`, { method: 'DELETE' });
                    if (response.ok) {
                        showToast('Bot deleted', 'success');
                        loadBots();
                    }
                } catch (error) {
                    showToast('Error deleting bot: ' + error.message, 'error');
                }
            }
        }

        function selectBot(idx) {
            selectedBot = idx;
            const logs = allBots[idx]?.logs || [];
            document.getElementById('selectedLogs').innerHTML = logs.length > 0
                ? logs.map(log => `<div class="log-entry ${getLogClass(log)}">${escapeHtml(log)}</div>`).join('')
                : '<div class="empty-state">No logs for this bot</div>';
        }

        function showLogTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tab === 'all' ? 'allLogs' : 'selectedLogs').classList.add('active');
            event.target.classList.add('active');
        }

        function getLogClass(log) {
            if (log.includes('ERROR') || log.includes('error')) return 'log-error';
            if (log.includes('SUCCESS') || log.includes('success')) return 'log-success';
            if (log.includes('INFO') || log.includes('info')) return 'log-info';
            return '';
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'flex';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        // Fetch all logs periodically
        setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE}/logs`);
                const allLogs = await response.json();
                document.getElementById('allLogs').innerHTML = allLogs.length > 0
                    ? allLogs.map(log => `<div class="log-entry ${getLogClass(log)}">${escapeHtml(log)}</div>`).join('')
                    : '<div class="empty-state">No activity logs</div>';
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }, 2000);
    </script>
</body>
</html>
